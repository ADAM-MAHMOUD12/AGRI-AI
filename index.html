<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููุตุฉ ุงูุฒุฑุงุนุฉ ุงูุฐููุฉ - ุชุญุณูู ุงูููุงุฑุฏ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-green': { // ููู ุฃุณุงุณู ุฃุฎุถุฑ ุนููู
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a', // ุงูุชุฑููุฒ ุนูู ูุฐุง ุงูููู ููุฃุฒุฑุงุฑ
                            700: '#15803d',
                            800: '#14532d',
                            900: '#052e16',
                            950: '#010f05',
                        },
                        'secondary-blue': { // ููู ุซุงููู ูููุชุงุฆุฌ ูุงูุจูุงูุงุช
                            50: '#eff6ff',
                            100: '#dbeafe',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* ุฅุฎูุงุก ุดุฑูุท ุงูุชูุฑูุฑ ูุฃูุณุงู ูุญุฏุฏุฉ ุฅุฐุง ูุฒู ุงูุฃูุฑ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">
    <div id="app" class="max-w-5xl mx-auto">
        
        <header class="text-center mb-12 p-8 bg-white rounded-3xl shadow-xl border-t-8 border-primary-green-600 transition-all duration-300 hover:shadow-2xl">
            <h1 class="text-4xl sm:text-5xl font-black text-primary-green-800 mb-3">
                ๐ฑ ููุตุฉ ุงูุฒุฑุงุนุฉ ุงูุฐููุฉ (<span class="text-secondary-blue-600">Agri-AI</span>)
            </h1>
            <p class="text-gray-600 text-xl font-medium">ุชุญููู ูุชูุฏู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู ูู <span class="text-primary-green-600 font-bold">ุชุญุณูู ููุงุกุฉ</span> ุงุณุชุฎุฏุงู ุงูููุงู ูุงูุฃุณูุฏุฉ.</p>
        </header>
        
        <div class="bg-white p-6 sm:p-10 rounded-3xl shadow-2xl mb-12 border-l-4 border-primary-green-600">
            <h2 class="text-3xl font-extrabold text-primary-green-700 mb-8 border-b-2 pb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 ml-3 text-primary-green-500" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-4.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
                </svg>
                ุฅุฏุฎุงู ุจูุงูุงุช ุงููุฒุฑุนุฉ
            </h2>
            <form id="farm-data-form" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <label for="crop_type" class="block text-sm font-semibold text-gray-700 mb-2">ููุน ุงููุญุตูู ุงูุญุงูู:</label>
                    <input type="text" id="crop_type" value="ููุญ" required
                           class="w-full p-4 border border-gray-300 rounded-xl focus:ring-primary-green-500 focus:border-primary-green-500 transition duration-300 placeholder-gray-400 text-lg shadow-sm"
                           placeholder="ูุซุงู: ููุญุ ุทูุงุทูุ ุนูุจ">
                </div>
                <div>
                    <label for="field_size" class="block text-sm font-semibold text-gray-700 mb-2">ุญุฌู ุงูุญูู (ุจุงููุชุฑ ุงููุฑุจุน):</label>
                    <input type="number" id="field_size" value="10000" required min="1"
                           class="w-full p-4 border border-gray-300 rounded-xl focus:ring-primary-green-500 focus:border-primary-green-500 transition duration-300 placeholder-gray-400 text-lg shadow-sm"
                           placeholder="ุฃุฏุฎู ุงูุญุฌู ุจุงููุชุฑ ุงููุฑุจุน">
                </div>
                <div>
                    <label for="soil_type" class="block text-sm font-semibold text-gray-700 mb-2">ููุน ุงูุชุฑุจุฉ:</label>
                    <select id="soil_type" required
                            class="w-full p-4 border border-gray-300 bg-white rounded-xl focus:ring-primary-green-500 focus:border-primary-green-500 transition duration-300 text-lg shadow-sm appearance-none">
                        <option value="ุทูููุฉ" selected>ุทูููุฉ</option>
                        <option value="ุฑูููุฉ">ุฑูููุฉ</option>
                        <option value="ุทูููุฉ">ุทูููุฉ</option>
                        <option value="ุฌูุฑูุฉ">ุฌูุฑูุฉ</option>
                    </select>
                </div>
                <div>
                    <label for="current_water" class="block text-sm font-semibold text-gray-700 mb-2">ุงูุงุณุชุฎุฏุงู ุงูุญุงูู ููููุงู (ูุชุฑ ููุนุจ/ุฃุณุจูุน):</label>
                    <input type="number" id="current_water" value="150" required min="0"
                           class="w-full p-4 border border-gray-300 rounded-xl focus:ring-primary-green-500 focus:border-primary-green-500 transition duration-300 placeholder-gray-400 text-lg shadow-sm"
                           placeholder="ุงููููุฉ ุงูุญุงููุฉ ุจุงููุชุฑ ุงูููุนุจ">
                </div>
                <div class="md:col-span-2">
                    <label for="current_fertilizer" class="block text-sm font-semibold text-gray-700 mb-2">ููุน ููููุฉ ุงูุณูุงุฏ ุงูุญุงูู (ูุซุงู: NPK 20-20-20 ุจููุฏุงุฑ 5 ุฌุฑุงู/ูุชุฑ ูุฑุจุน):</label>
                    <input type="text" id="current_fertilizer" value="NPK 20-20-20 ุจููุฏุงุฑ 5 ุฌุฑุงู/ูุชุฑ ูุฑุจุน ุดูุฑูุงู" required
                           class="w-full p-4 border border-gray-300 rounded-xl focus:ring-primary-green-500 focus:border-primary-green-500 transition duration-300 placeholder-gray-400 text-lg shadow-sm"
                           placeholder="ุฃุฏุฎู ุชูุงุตูู ุงูุณูุงุฏ ุจูุญุฏุงุช ูุชุฑูุฉ">
                </div>
                <div class="md:col-span-2 mt-6">
                    <button type="submit" id="analyze-button"
                            class="w-full bg-primary-green-600 text-white font-bold text-xl py-4 px-4 rounded-xl hover:bg-primary-green-700 transition duration-300 focus:outline-none focus:ring-4 focus:ring-primary-green-500 focus:ring-opacity-50 shadow-lg hover:shadow-xl flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="button-text">ุชุญููู ูุชุญุณูู ุงูููุงุฑุฏ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู</span>
                        <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-6 w-6 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
        
        <div id="results-section" class="bg-white p-6 sm:p-10 rounded-3xl shadow-2xl hidden border-l-4 border-secondary-blue-600 transition-all duration-500">
            <h2 class="text-3xl font-extrabold text-secondary-blue-700 mb-8 border-b-2 pb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 ml-3 text-secondary-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                </svg>
                ูุชุงุฆุฌ ุงูุชุญููู ูุงูุชูุตูุงุช ุงูุฐููุฉ
            </h2>
            <div id="loading-error-message" class="text-red-700 bg-red-100 p-4 rounded-xl hidden mb-4 font-medium border border-red-300"></div>
            <div id="ai-output" class="space-y-8">
                <div class="p-6 bg-secondary-blue-50 rounded-2xl border border-secondary-blue-200">
                    <h3 class="text-xl font-bold text-secondary-blue-700 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                        ุงูุชุญููู ุงูุนุงู
                    </h3>
                    <p class="text-gray-700 whitespace-pre-wrap font-medium" id="ai-analysis-placeholder">ุงูุชุญููู ุงูุนุงู ููุถุน ุงููุฒุฑุนุฉ ุงูุญุงูู ุณูุธูุฑ ููุง.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="p-6 bg-primary-green-100 rounded-2xl border border-primary-green-300 md:col-span-1 flex flex-col justify-center">
                        <h3 class="text-xl font-bold text-primary-green-700 mb-2 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l3 3a1 1 0 001.414-1.414L11 10.586V6z" clip-rule="evenodd" />
                            </svg>
                            ุงูุชูููุฑ ุงููุชููุน
                        </h3>
                        <p class="text-primary-green-800 font-extrabold text-3xl whitespace-pre-wrap" id="ai-savings-placeholder">--%</p>
                    </div>
                    <div class="p-6 bg-blue-100 rounded-2xl border border-blue-300 md:col-span-2">
                        <h3 class="text-xl font-bold text-blue-700 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-droplet"><path d="M12 2.69l5.66 5.66c.86.86 1.34 2.01 1.34 3.2v.01a4 4 0 0 1-4 4h-4a4 4 0 0 1-4-4v-.01c0-1.19.48-2.34 1.34-3.2L12 2.69z"></path><path d="M12 20a8 8 0 0 0 0-16v16z"></path></svg>
                            ุชูุตูุฉ ุงูุฑู
                        </h3>
                        <p class="text-gray-700 whitespace-pre-wrap font-medium" id="ai-water-placeholder">ุงูุชุฑุงุญ ุฌุฏูู ุงูุฑู ุงููุญุณูู ุณูุธูุฑ ููุง.</p>
                    </div>
                </div>

                <div class="p-6 bg-yellow-100 rounded-2xl border border-yellow-300">
                    <h3 class="text-xl font-bold text-yellow-700 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M11 3a1 1 0 100 2h2.276a1 1 0 01.996.883L16 16.5A1.5 1.5 0 0114.5 18h-9A1.5 1.5 0 014 16.5L6.728 5.883A1 1 0 017.724 5H10zm3.385 1.5l-2 8.41a1 1 0 01-.98.79H7.615a1 1 0 01-.98-.79l-2-8.41h7.75z" />
                        </svg>
                        ุชูุตูุฉ ุงูุฃุณูุฏุฉ
                    </h3>
                    <p class="text-gray-700 whitespace-pre-wrap font-medium" id="ai-fertilizer-placeholder">ุงูุชุฑุงุญ ุชุฑููุจุฉ ุงูุณูุงุฏ ุงููุญุณููุฉ ุณูุธูุฑ ููุง.</p>
                </div>
            </div>
        </div>
        
        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p class="font-light">ูุชู ุงุณุชุฎุฏุงู (ADAM API).</p>
        </footer>
    </div>
    
    <script type="module">
        // ููุงุญุธุฉ: ุชู ุชุนุฏูู ุฏุงูุฉ displayResults ูุงุณุชุฎุฏุงู ุงูููุงูู ุงูุฌุฏูุฏุฉ ูุงูุญููู ุงููุนุฑูุถุฉ ุฃุนูุงู.
        
        // ุงูุซูุงุจุช
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // **[ุชุญุฏูุซ] ููุชุงุญ OpenRouter API ุงูุฌุฏูุฏ** (ููุชุฑุถ)
        const apiKey = "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"; 
        
        // **[ุชุญุฏูุซ] ุฅุนุฏุงุฏุงุช OpenRouter API**
        const modelName = 'google/gemini-2.5-flash'; // ูููุฐุฌ ูุชูุงูู ูุน Gemini
        const apiUrl = 'https://openrouter.ai/api/v1/chat/completions';
        
        // ุนูุงุตุฑ ูุงุฌูุฉ ุงููุณุชุฎุฏู
        const form = document.getElementById('farm-data-form');
        const resultsSection = document.getElementById('results-section');
        const aiOutputDiv = document.getElementById('ai-output');
        const analyzeButton = document.getElementById('analyze-button');
        const buttonText = document.getElementById('button-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessageDiv = document.getElementById('loading-error-message');
        
        // ุฏุงูุฉ ุงููุณุงุนุฏ ูุชุญููู ุงูุจูุงูุงุช ุฅูู ุชูุณูู JSON ุนุฑุจู (ุจุฏูู ุชุบููุฑ)
        function formatDataForAI(data) {
            return `
                ุจูุงูุงุช ุงููุฒุฑุนุฉ ููุชุญููู:
                - ููุน ุงููุญุตูู: ${data.crop_type}
                - ุญุฌู ุงูุญูู: ${data.field_size} ูุชุฑ ูุฑุจุน
                - ููุน ุงูุชุฑุจุฉ: ${data.soil_type}
                - ุงูุงุณุชุฎุฏุงู ุงูุญุงูู ููููุงู: ${data.current_water} ูุชุฑ ููุนุจ/ุฃุณุจูุน
                - ุงูุงุณุชุฎุฏุงู ุงูุญุงูู ููุฃุณูุฏุฉ: ${data.current_fertilizer}

                ุญูู ูุฐู ุงูุจูุงูุงุช ููุฏู ุชูุตูุงุช ููุญุณููุฉ ูู ุชูุณูู JSON ุจุงููุบุฉ ุงูุนุฑุจูุฉ. ูุฌุจ ุฃู ุชููู ุฌููุน ุงูุชูุตูุงุช ุงูุฎุงุตุฉ ุจุงูููุงุณุงุช ุจุงููุญุฏุงุช ุงููุชุฑูุฉ (ูุชุฑ ูุฑุจุนุ ูุชุฑ ููุนุจุ ูุฌูุ ุฌุฑุงู).
            `;
        }

        // ุฏุงูุฉ ูุนุฑุถ ุงููุชุงุฆุฌ ูู ูุงุฌูุฉ ุงููุณุชุฎุฏู (ูุญุฏุซุฉ ูุงุณุชุฎุฏุงู ุงูุชุฎุทูุท ุงูุฌุฏูุฏ)
        function displayResults(data) {
            // ุชุญุฏูุซ ูุญุชูู ุงูู placeholders ุฏุงุฎู ai-output
            document.getElementById('ai-analysis-placeholder').textContent = data['ุชุญููู_ุนุงู'];
            document.getElementById('ai-savings-placeholder').textContent = data['ุชูููุฑ_ูุชููุน'];
            document.getElementById('ai-water-placeholder').textContent = data['ุชูุตูุฉ_ุงูุฑู'];
            document.getElementById('ai-fertilizer-placeholder').textContent = data['ุชูุตูุฉ_ุงูุฃุณูุฏุฉ'];
            
            // ุฅุธูุงุฑ ูุณู ุงููุชุงุฆุฌ
            resultsSection.classList.remove('hidden');
            resultsSection.scrollIntoView({ behavior: 'smooth' }); // ุชูุฑูุฑ ุณูุณ ูููุชุงุฆุฌ
        }

        // ุฏุงูุฉ ุชูููุฐ ุงูุงุชุตุงู ุจูุงุฌูุฉ ุจุฑูุฌุฉ ุชุทุจููุงุช OpenRouter (ุจุฏูู ุชุบููุฑ)
        async function callAI(prompt, retryCount = 0) {
            // ุฅุธูุงุฑ ุญุงูุฉ ุงูุชุญููู
            analyzeButton.disabled = true;
            buttonText.textContent = 'ุฌุงุฑู ุงูุชุญููู...';
            loadingSpinner.classList.remove('hidden');
            errorMessageDiv.classList.add('hidden');
            resultsSection.classList.add('hidden');
            
            // ุฅุนุงุฏุฉ ุชุนููู ูุญุชูู ุงูู placeholders
            document.getElementById('ai-analysis-placeholder').textContent = "ุฌุงุฑู ุฌูุจ ุงูุชุญููู...";
            document.getElementById('ai-savings-placeholder').textContent = "--%";
            document.getElementById('ai-water-placeholder').textContent = "ุฌุงุฑู ุฌูุจ ุชูุตูุฉ ุงูุฑู...";
            document.getElementById('ai-fertilizer-placeholder').textContent = "ุฌุงุฑู ุฌูุจ ุชูุตูุฉ ุงูุฃุณูุฏุฉ...";


            const systemPrompt = `ุฃูุช ุฎุจูุฑ ุฐูุงุก ุงุตุทูุงุนู ุฒุฑุงุนู ูุชุฎุตุต ูู ุชุญุณูู ุงูููุงุฑุฏ. ุจูุงุกู ุนูู ุจูุงูุงุช ุงููุฒุฑุนุฉ ุงููุฏุฎูุฉุ ูุฏู ุชุญูููุงู ุฏููููุง ูุชูุตูุงุช ููุญุณููุฉ ูุงุณุชุฎุฏุงู ุงูููุงู ูุงูุฃุณูุฏุฉ. ูุฌุจ ุฃู ูููู ุงููุงุชุฌ ุจุชูุณูู JSON ุตุงุฑู ุจุงููุบุฉ ุงูุนุฑุจูุฉ ููุณุชุฎุฏู ุงูุญููู ุงูุชุงููุฉ ููุท: "ุชุญููู_ุนุงู" (ุชุญููู ุดุงูู ููุถุน ุงููุฒุฑุนุฉ ุงูุญุงูู)ุ "ุชูุตูุฉ_ุงูุฑู" (ุงูุชุฑุงุญ ูุฌุฏูู ุฑู ูุญุณูู)ุ "ุชูุตูุฉ_ุงูุฃุณูุฏุฉ" (ุงูุชุฑุงุญ ูุชุฑููุจุฉ ุณูุงุฏูุฉ)ุ "ุชูููุฑ_ูุชููุน" (ูุณุจุฉ ุงูุชูููุฑ ุงููุชููุนุฉ ูู ุงูููุงู ูุงูุฃุณูุฏุฉ). ูุฌุจ ุฃู ุชุณุชุฎุฏู ุฌููุน ุงูุชูุตูุงุช ุงูููุงุณุงุช ุงููุชุฑูุฉ (ุงููุชุฑุ ุงููุชุฑ ุงููุฑุจุนุ ุงููุชุฑ ุงูููุนุจ).`;

            // ูููู ุงูุญูููุฉ (Payload) ุงูุฎุงุต ุจู OpenRouter/Chat Completions
            const payload = {
                model: modelName,
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: prompt }
                ],
                // ุทูุจ ุฅุฎุฑุงุฌ JSON ูุชุญุณูู ุงูููุซูููุฉ
                response_format: { type: "json_object" },
                temperature: 0.2, // ุฏุฑุฌุฉ ุญุฑุงุฑุฉ ููุฎูุถุฉ ููุชุงุฆุฌ ุฃูุซุฑ ูุงูุนูุฉ
                max_tokens: 2048
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`, // ุงุณุชุฎุฏุงู ููุชุงุญ OpenRouter
                        'HTTP-Referer': window.location.href, // ููุงุฑุณุงุช OpenRouter ุงูููุตู ุจูุง
                        'X-Title': 'Agri-AI Optimizer App'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorDetails = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}. Details: ${errorDetails}`);
                }

                const result = await response.json();
                // ุงุณุชุฎุฑุงุฌ ุงููุญุชูู ูู ุงุณุชุฌุงุจุฉ Chat Completions
                const jsonText = result.choices?.[0]?.message?.content;

                if (!jsonText) {
                    throw new Error("ูู ูุชู ุงูุญุตูู ุนูู ูุญุชูู ุงุณุชุฌุงุจุฉ ุตุงูุญ ูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู.");
                }

                // ุชุญููู ุงููุต JSON
                // ุชูุธูู ุงููุต ุนู ุทุฑูู ุฅุฒุงูุฉ ุฃู ููุฏ ูุงุฑู ุฏุงูู ุฃู ุชุฑููุณุงุช ูุจู ุงูุชุญููู
                const cleanJsonText = jsonText.replace(/```json\n|```/g, '').trim(); 
                const parsedData = JSON.parse(cleanJsonText);

                // ุงูุชุฃูุฏ ูู ุฃู ุฌููุน ุงูุญููู ุงููุทููุจุฉ ููุฌูุฏุฉ
                if (!parsedData['ุชุญููู_ุนุงู'] || !parsedData['ุชูุตูุฉ_ุงูุฑู'] || !parsedData['ุชูุตูุฉ_ุงูุฃุณูุฏุฉ'] || !parsedData['ุชูููุฑ_ูุชููุน']) { 
                     throw new Error("ุงูุงุณุชุฌุงุจุฉ ูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุบูุฑ ููุชููุฉ ุฃู ูุง ุชุชูุงูู ูุน ุงูุชูุณูู ุงููุทููุจ.");
                }

                displayResults(parsedData);

            } catch (error) {
                console.error("AI API Call Failed (OpenRouter):", error);

                if (retryCount < 3) {
                    const delay = Math.pow(2, retryCount) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    console.log(`Retrying AI call (Attempt ${retryCount + 2})...`);
                    await callAI(prompt, retryCount + 1);
                    return;
                }

                errorMessageDiv.textContent = `ูุดู ุงูุชุญููู: ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจูุงุฌูุฉ ุจุฑูุฌุฉ ุชุทุจููุงุช OpenRouter. ูุฑุฌู ุงูุชุฃูุฏ ูู ุตุญุฉ ุงูููุชุงุญ ูุฅุนุงุฏุฉ ุงููุญุงููุฉ. (${error.message})`;
                errorMessageDiv.classList.remove('hidden');

            } finally {
                // ุฅุฎูุงุก ุญุงูุฉ ุงูุชุญููู
                analyzeButton.disabled = false;
                buttonText.textContent = 'ุชุญููู ูุชุญุณูู ุงูููุงุฑุฏ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู';
                loadingSpinner.classList.add('hidden');
            }
        }

        // ูุนุงูุฌ ุฅุฑุณุงู ุงููููุฐุฌ (ุจุฏูู ุชุบููุฑ)
        form.addEventListener('submit', async (e) => {
            // ููุน ุงูุณููู ุงูุงูุชุฑุงุถู (ูุญู ูุดููุฉ ุงูุนูุฏุฉ ููุฃุนูู)
            e.preventDefault(); 

            const farmData = {
                crop_type: document.getElementById('crop_type').value,
                field_size: document.getElementById('field_size').value,
                soil_type: document.getElementById('soil_type').value,
                current_water: document.getElementById('current_water').value,
                current_fertilizer: document.getElementById('current_fertilizer').value,
            };

            const userPrompt = formatDataForAI(farmData);
            await callAI(userPrompt);
        });
    </script>
</body>
</html>
